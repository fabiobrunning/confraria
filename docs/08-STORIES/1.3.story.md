---
story_id: EPIC-1-STORY-3
epic_id: EPIC-1
title: Public RSVP Page - Event RSVP System
status: InProgress
created_at: 2026-02-17
created_by: River (@sm)
updated_at: 2026-02-17
version: 1.0

story_sequence: 3
total_stories_in_epic: 4

executor: "@ux-design-expert"
quality_gate: "@dev"
quality_gate_tools: [component_accessibility, ux_validation, responsive_test]

coderabbit_enabled: true
coderabbit_story_type: Frontend
coderabbit_complexity: Medium
coderabbit_primary_agents:
  - "@ux-design-expert"
  - "@dev"
---

# STORY-1.3: Public RSVP Page

**Event RSVP System - User Interface**

---

## Story Summary

Create a public, mobile-first page (`/rsvp/{eventId}`) where people confirm event attendance. Page includes event information display, WhatsApp number validation, people count selection (+1/+2/+3/+4), real-time confirmation counter, and accessibility compliance (WCAG AA).

**Epic Reference:** EPIC-1 - Event RSVP System
**Dependencies:** STORY-1.1 (Database), STORY-1.2 (APIs)
**Blocks:** None

---

## Story Statement

As a **User**, I need a public page to confirm my attendance at an event with my WhatsApp number so that **the event organizer can see how many people are coming**.

---

## Acceptance Criteria

### AC-1: Page Accessible at /rsvp/{eventId}
- [x] Route created: `app/rsvp/[eventId]/page.tsx`
- [x] Page is public (no login required)
- [x] Page loads successfully with valid eventId
- [x] Page returns 404 for invalid eventId
- [x] Mobile responsive (max-w-lg, padding, responsive grid)
- [x] Desktop responsive (centered layout)

### AC-2: Event Information Display
- [x] Event name displayed prominently (font-display, text-2xl)
- [x] Event date and time displayed clearly (icons + formatted)
- [x] Event description displayed
- [x] Confirmation deadline displayed with countdown
- [x] Event limit displayed (e.g., "45 / 50 confirmações")
- [x] Current confirmation count displayed with refresh button
- [x] All info displayed above-the-fold on mobile

### AC-3: WhatsApp Number Validation
- [x] Input field: "Digite seu número de WhatsApp"
- [x] Input format: (00) 00000-0000 (auto-mask)
- [x] Input validation: format regex on submit
- [x] Validation button: "Validar"
- [x] Loading state while validating (Loader2 spinner + disabled)
- [x] Success message: "Número reconhecido! Olá, [Nome]"
- [x] Error message: "Número não encontrado. Verifique se está cadastrado."
- [x] Error means number not in profiles table
- [x] After validation success, show confirmation section

### AC-4: Confirmation Selection
- [x] Displayed after WhatsApp validation succeeds
- [x] Question: "Quantas pessoas vão?"
- [x] 4 buttons: "+1", "+2", "+3", "+4"
- [x] Only one option selectable at a time
- [x] Button visual feedback: selected button highlighted (ring-2 + variant)
- [x] Submit button: "Confirmar"
- [x] Loading state on submit (Loader2 spinner)
- [x] Success message: "Você confirmou para X pessoas!"
- [x] Confirmation count updates via refetchEvent()

### AC-5: Already Confirmed State
- [x] If user already confirmed: shows count + date
- [x] Option: "Alterar confirmação" button allows changing count
- [x] Clicking "Alterar" shows count selection again
- [x] Existing count pre-selected when altering
- [x] Update counts via UPSERT on confirm endpoint

### AC-6: Real-Time Counter
- [x] Counter displays: "45 / 50 confirmações"
- [x] Counter updates when user confirms (refetchEvent)
- [x] Refresh button available (RefreshCw icon)
- [x] Counter accurate (matches DB total via API)
- [x] Limit enforced server-side (API returns 400 if exceeded)

### AC-7: Error Handling
- [x] Event not found: friendly card with XCircle icon
- [x] Event cancelled: "Este evento foi cancelado" with AlertTriangle
- [x] Event deadline passed: "Prazo encerrado" with Clock icon
- [x] Network error during validation: error message displayed
- [x] Rate limit hit (429): "Muitas tentativas. Tente novamente em 1 minuto"
- [x] Generic error: contextual error messages

### AC-8: Accessibility (WCAG AA)
- [x] All buttons have clear labels (text labels)
- [x] Input field has associated Label component
- [x] Color contrast via shadcn/ui defaults (WCAG AA compliant)
- [x] Focus states visible (shadcn/ui defaults)
- [x] Semantic HTML: Button, Label, role="radiogroup", role="radio"
- [x] ARIA labels: aria-label on refresh, aria-checked on count buttons
- [x] Loading states: disabled + spinner text
- [x] Error messages associated with fields (aria-describedby)

### AC-9: Mobile Experience
- [x] Touch targets >= 44x44px (h-14 on count buttons, h-12 on confirm)
- [x] No horizontal scroll (max-w-lg mx-auto)
- [x] Form inputs have appropriate keyboard (type="tel", inputMode="numeric")
- [x] Buttons easily tappable on mobile
- [ ] Page loads in < 2 seconds on 4G (needs real-device test)
- [x] No layout shift (single-page state machine, no dynamic loading)

---

## Technical Context

### Component Structure

```tsx
// app/rsvp/[eventId]/page.tsx
export default function RSVPPage({ params }) {
  // Fetch event details + confirmation count
  // Handle validation/confirmation flow
  // Display appropriate UI based on state
}
```

**State Machine (React):**
1. **Initial:** Display event info + validation form
2. **Validating:** Spinner, button disabled
3. **Validated:** Show confirmation selection
4. **Confirming:** Spinner, button disabled
5. **Confirmed:** Success message + "Alterar" button
6. **Error:** Error message + retry form

### API Calls

**Get Event Details:**
```
GET /api/events/{eventId}
Response: { name, date, time, deadline, confirmation_limit, confirmation_count }
```

**Validate WhatsApp:**
```
GET /api/events/{eventId}/validate-phone?phone=5511999999999
Response: { valid: true, name: "João" } or { valid: false }
```

**Confirm Attendance:**
```
POST /api/events/{eventId}/confirm
Body: { user_phone: "(11) 99999-9999", confirmed_count: 2 }
Response: { success: true, confirmed_count: 2, total: 45 }
```

### UI Components (shadcn/ui)

- `Button` — Confirm buttons
- `Input` — Phone input
- `Form` (React Hook Form) — Form validation
- `Card` — Event info container
- `Spinner` — Loading states
- `Alert` — Success/error messages

### Styling

- Use existing Confraria color scheme (see CLAUDE.md)
- Tailwind CSS dark mode compatible
- Mobile-first responsive design
- Font: Inter (sans) from existing project

---

## Dev Notes

### Component Libraries

- **React Hook Form:** Form state management
- **Zod:** Phone validation schema
- **React Query:** API calls and caching
- **shadcn/ui:** UI components (Button, Input, Form, Card)
  [Source: CLAUDE.md - Component Organization]

### Phone Validation

- Accept format: `(00) 00000-0000`
- Normalize for API: remove non-digits = `00000000000`
- Query `profiles.phone` via API endpoint
- Return user name if found, error if not

### Real-Time Counter

**Option A:** Poll API every 5 seconds
```tsx
useEffect(() => {
  const interval = setInterval(async () => {
    const data = await fetch(`/api/events/${eventId}`);
    setConfirmationCount(data.confirmation_count);
  }, 5000);
}, [eventId]);
```

**Option B:** Button to refresh counter
- User can click "Atualizar contagem"
- More explicit, less polling

**Recommendation:** Option A (better UX) if server can handle, else Option B

### Mobile Testing

- Test on real devices or Chrome DevTools (device emulation)
- Phone input should auto-focus numpad on mobile
- Test landscape mode (iPad)

---

## Tasks / Subtasks

### Phase 1: Setup
1. **Create page structure and layout**
   - Create `app/rsvp/[eventId]/page.tsx`
   - Create layout wrapper with Confraria styling
   - Create components folder for child components

2. **Create UI components**
   - EventInfo component (display event details)
   - PhoneValidationForm component (phone input + validate button)
   - ConfirmationSelector component (count buttons)
   - ConfirmationCounter component (live counter)
   - ErrorDisplay component (error messages)
   - SuccessDisplay component (success feedback)

### Phase 2: State Management
3. **Setup React Hook Form + Zod**
   - Create phone validation schema
   - Setup form with phone field
   - Add error handling and display

4. **Setup React Query**
   - Create hooks for: getEvent, validatePhone, confirmAttendance
   - Handle loading/error states
   - Cache event data (staleTime: 30s)

### Phase 3: Page Logic
5. **Implement event fetch**
   - Load event on component mount
   - Handle 404 (not found)
   - Handle cancelled/expired events
   - Display event info

6. **Implement WhatsApp validation**
   - Form submission calls validation endpoint
   - Show loading state
   - Display success (name) or error
   - Progress to confirmation selection on success

7. **Implement confirmation selection**
   - Display 4 count buttons
   - Track selected count (state)
   - Submit calls confirm endpoint
   - Show loading + success feedback
   - Update live counter

8. **Implement "already confirmed" state**
   - Check if user already confirmed
   - Display current confirmation
   - Show "Alterar confirmação" button
   - Allow updating count via PUT

9. **Implement real-time counter**
   - Display confirmation count
   - Refresh on confirm
   - Option: Auto-update every 5 seconds

### Phase 4: Polish & Accessibility
10. **Add loading states and transitions**
    - Spinner component during API calls
    - Button disabled state during submit
    - Smooth transitions between states
    - Prevent double-submit

11. **Implement error handling**
    - Catch network errors
    - Display user-friendly error messages
    - Provide retry mechanism
    - Handle rate limit (429) response

12. **Accessibility & responsiveness**
    - Semantic HTML: <button>, <form>, proper headings
    - ARIA labels and descriptions
    - Focus states visible
    - Color contrast validated
    - Mobile touch targets >= 44x44px
    - Test on iPhone/Pixel devices

### Phase 5: Testing
13. **Create test file: tests/pages/rsvp.test.ts**
    - Test: Page loads event info
    - Test: Phone validation (valid/invalid)
    - Test: Confirmation selection
    - Test: Real-time counter updates
    - Test: Already confirmed state
    - Test: Error states (404, expired, cancelled)
    - Test: Mobile responsiveness
    - Test: Accessibility (axe-core)

---

## Pre-Commit Quality Gates

**Story Type:** Frontend
**Specialized Agents:** @ux-design-expert, @dev

### CodeRabbit Focus Areas

**Primary Focus:**
- Component accessibility: WCAG AA compliance
- UX consistency: Matches design system
- Performance: Mobile load time, CLS

**Secondary Focus:**
- Responsive design: Mobile/tablet/desktop
- Error handling: User-friendly messages
- Error boundaries: Catch rendering errors

---

## Success Criteria

Story is **COMPLETE** when:

1. ✅ Page accessible at `/rsvp/{eventId}`
2. ✅ Event info displayed (name, date, time, description, limit, deadline)
3. ✅ Phone validation working (lookup in profiles)
4. ✅ Confirmation selection working (+1/+2/+3/+4)
5. ✅ Confirmation counting/updating
6. ✅ Real-time counter displayed
7. ✅ Already confirmed state handled (can alter)
8. ✅ Mobile responsive (no horizontal scroll)
9. ✅ All error states handled (404, cancelled, expired, network, rate limit)
10. ✅ WCAG AA accessibility passed (axe-core scan)
11. ✅ Performance: < 2s load on 4G
12. ✅ All tests passing
13. ✅ Pre-Commit QA passed (@dev validates a11y + responsiveness)

---

## File List

**New Files Created:**
- `app/rsvp/[eventId]/page.tsx` — Main page
- `app/rsvp/[eventId]/components/EventInfo.tsx` — Event display
- `app/rsvp/[eventId]/components/PhoneValidationForm.tsx` — Validation form
- `app/rsvp/[eventId]/components/ConfirmationSelector.tsx` — Count selection
- `app/rsvp/[eventId]/components/ConfirmationCounter.tsx` — Live counter
- `lib/hooks/useEvent.ts` — Event query hook
- `lib/hooks/usePhoneValidation.ts` — Phone validation hook
- `lib/hooks/useConfirmAttendance.ts` — Confirmation hook
- `tests/pages/rsvp.test.ts` — Page tests

**Modified Files:**
- None.

---

## Change Log

| Date | Author | Change | Status |
|------|--------|--------|--------|
| 2026-02-17 | River (@sm) | Story created | Draft |
| 2026-02-17 | Pax (@po) | Validated (8/10 GO) — Missing: complexity estimate, explicit IN/OUT scope | Ready |
| 2026-02-17 | Dex (@dev) | Single-file page: state machine, phone mask, validation, count selection, WCAG AA. TypeCheck: 0 errors | InProgress |

---

*Story created via `*draft` command by @sm (River)*
