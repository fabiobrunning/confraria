---
story_id: EPIC-1-STORY-1
epic_id: EPIC-1
title: Database Schema & RLS Policies - Event RSVP System
status: InProgress
created_at: 2026-02-17
created_by: River (@sm)
updated_at: 2026-02-17
version: 1.0

story_sequence: 1
total_stories_in_epic: 4

# Executor Assignment (Story 11.1)
executor: "@data-engineer"
quality_gate: "@dev"
quality_gate_tools: [schema_validation, rls_test, migration_review]

# CodeRabbit Integration (Story 6.3.3)
coderabbit_enabled: true
coderabbit_story_type: Database
coderabbit_complexity: Medium
coderabbit_primary_agents:
  - "@data-engineer"
  - "@dev"
---

# STORY-1.1: Database Schema & RLS Policies

**Event RSVP System - Database Foundation**

---

## Story Summary

Create the database foundation for the Event RSVP system by implementing two new tables (`events` and `event_confirmations`) with all required columns, indexes, Row-Level Security (RLS) policies, and soft delete patterns.

**Epic Reference:** EPIC-1 - Event RSVP System
**Dependencies:** None (foundation story)
**Blocks:** Story 1.2 (APIs), Story 1.3 (RSVP Page), Story 1.4 (Admin Dashboard)

---

## Story Statement

As a **Data Engineer**, I need to create the database schema for the Event RSVP system so that **the system can store events and confirmations securely with proper RLS policies**.

---

## Acceptance Criteria

### AC-1: Events Table Created
- [x] Table `events` exists in Supabase with all required columns:
  - `id` (UUID, Primary Key, default: `gen_random_uuid()`)
  - `name` (text, NOT NULL) - Event name
  - `description` (text, NOT NULL) - Event description
  - `date` (date, NOT NULL) - Event date
  - `time` (time, NOT NULL) - Event time
  - `deadline` (timestamp, NOT NULL) - Deadline for confirmations
  - `confirmation_limit` (integer, NOT NULL) - Max number of people who can confirm
  - `status` (text, NOT NULL, CHECK in ('active', 'cancelled'), default: 'active')
  - `created_by` (UUID, NOT NULL, FK to `profiles.id`) - Admin who created
  - `created_at` (timestamp, NOT NULL, default: `now()`)
  - `updated_at` (timestamp, NOT NULL, default: `now()`)
  - `deleted_at` (timestamp, nullable) - Soft delete marker
- [x] Columns created with correct data types and constraints
- [x] Timestamps use UTC timezone (TIMESTAMPTZ)

### AC-2: Event Confirmations Table Created
- [x] Table `event_confirmations` exists with all required columns:
  - `id` (UUID, Primary Key, default: `gen_random_uuid()`)
  - `event_id` (UUID, NOT NULL, FK to `events.id`, ON DELETE CASCADE)
  - `user_phone` (text, NOT NULL) - WhatsApp number (format: +5511999999999)
  - `confirmed_count` (integer, NOT NULL) - Number of people confirmed (+1, +2, +3, +4)
  - `confirmed_at` (timestamp, NOT NULL, default: `now()`)
  - `created_at` (timestamp, NOT NULL, default: `now()`)
  - `updated_at` (timestamp, NOT NULL, default: `now()`)
- [x] Columns created with correct data types and constraints
- [x] Foreign key references `events.id` with CASCADE delete

### AC-3: Unique Constraint on Confirmations
- [x] Unique constraint `(event_id, user_phone)` prevents duplicate confirmations
- [x] Index created on `(event_id, user_phone)` for query performance

### AC-4: RLS Policies Implemented
- [x] RLS enabled on `events` table:
  - [x] Admins (role = 'admin') can view, insert, update, delete all events
  - [x] Members can view active events only (status = 'active', deleted_at IS NULL)
  - [x] Members CANNOT insert, update, or delete events
- [x] RLS enabled on `event_confirmations` table:
  - [x] Admins can view all confirmations
  - [x] Members can view only confirmations they created (matching user_phone)
  - [x] Members can insert and update their own confirmations only
  - [x] Public users (anonymous) blocked â€” public access will be handled via API with service role
- [x] Policies use `public.is_admin()` (SECURITY DEFINER) to avoid circular recursion

### AC-5: Soft Delete Pattern Implemented
- [x] `deleted_at` column used instead of physical delete
- [x] RLS policy filters events where `deleted_at IS NULL` for members
- [x] Archived events not returned in standard queries (admins see all via is_admin())

### AC-6: Migrations Created
- [x] Migration file created: `supabase/migrations/20260217200000_create_events_tables.sql`
- [x] Migration includes table creation, indexes, RLS policies
- [x] Migration is reversible (includes DROP commands in comments)
- [ ] Migration tested successfully in dev environment

### AC-7: No Regressions
- [ ] All existing tables and data unaffected
- [ ] Existing RLS policies on other tables unchanged
- [ ] No conflicts with existing columns in other tables
- [ ] Existing API routes continue to work

---

## Technical Context

### Data Models

**events Table Schema:**
```sql
CREATE TABLE events (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  description TEXT NOT NULL,
  date DATE NOT NULL,
  time TIME NOT NULL,
  deadline TIMESTAMP NOT NULL,
  confirmation_limit INTEGER NOT NULL CHECK (confirmation_limit > 0),
  status TEXT NOT NULL DEFAULT 'active' CHECK (status IN ('active', 'cancelled')),
  created_by UUID NOT NULL REFERENCES profiles(id),
  created_at TIMESTAMP NOT NULL DEFAULT now(),
  updated_at TIMESTAMP NOT NULL DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE INDEX idx_events_created_by ON events(created_by);
CREATE INDEX idx_events_status_deleted ON events(status, deleted_at)
  WHERE deleted_at IS NULL;
```

**event_confirmations Table Schema:**
```sql
CREATE TABLE event_confirmations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  event_id UUID NOT NULL REFERENCES events(id) ON DELETE CASCADE,
  user_phone TEXT NOT NULL,
  confirmed_count INTEGER NOT NULL CHECK (confirmed_count IN (1, 2, 3, 4)),
  confirmed_at TIMESTAMP NOT NULL DEFAULT now(),
  created_at TIMESTAMP NOT NULL DEFAULT now(),
  updated_at TIMESTAMP NOT NULL DEFAULT now(),
  UNIQUE(event_id, user_phone)
);

CREATE INDEX idx_event_confirmations_event_id ON event_confirmations(event_id);
CREATE INDEX idx_event_confirmations_user_phone ON event_confirmations(user_phone);
```

**RLS Policies:**
```sql
-- events table RLS
ALTER TABLE events ENABLE ROW LEVEL SECURITY;

-- Admins see all events
CREATE POLICY "Admins see all events"
  ON events FOR SELECT
  USING (auth.jwt() ->> 'role' = 'admin');

-- Members see active events only
CREATE POLICY "Members see active events"
  ON events FOR SELECT
  USING (auth.jwt() ->> 'role' != 'admin' AND status = 'active' AND deleted_at IS NULL);

-- Only admins can insert events
CREATE POLICY "Admins insert events"
  ON events FOR INSERT
  WITH CHECK (auth.jwt() ->> 'role' = 'admin');

-- Only admins can update events
CREATE POLICY "Admins update events"
  ON events FOR UPDATE
  USING (auth.jwt() ->> 'role' = 'admin')
  WITH CHECK (auth.jwt() ->> 'role' = 'admin');

-- Only admins can delete events
CREATE POLICY "Admins delete events"
  ON events FOR DELETE
  USING (auth.jwt() ->> 'role' = 'admin');

-- event_confirmations table RLS
ALTER TABLE event_confirmations ENABLE ROW LEVEL SECURITY;

-- Admins see all confirmations
CREATE POLICY "Admins see all confirmations"
  ON event_confirmations FOR SELECT
  USING (auth.jwt() ->> 'role' = 'admin');

-- Members see only their own confirmations
CREATE POLICY "Members see own confirmations"
  ON event_confirmations FOR SELECT
  USING (user_phone = (
    SELECT phone FROM profiles WHERE id = auth.uid()
  ));

-- Members can confirm attendance
CREATE POLICY "Members confirm attendance"
  ON event_confirmations FOR INSERT
  WITH CHECK (user_phone = (
    SELECT phone FROM profiles WHERE id = auth.uid()
  ));

-- Members can update own confirmations
CREATE POLICY "Members update own confirmations"
  ON event_confirmations FOR UPDATE
  USING (user_phone = (
    SELECT phone FROM profiles WHERE id = auth.uid()
  ))
  WITH CHECK (user_phone = (
    SELECT phone FROM profiles WHERE id = auth.uid()
  ));
```

### Database References

- **Tech Stack:** Supabase (PostgreSQL 14+) with PostgRES
  [Source: CLAUDE.md - Architecture section]
- **Existing Patterns:** Projects use soft delete (`deleted_at`), UUID primary keys, TIMESTAMP timestamps
  [Source: CLAUDE.md - Key Database Tables]
- **RLS Patterns:** Existing tables (profiles, companies, groups) use role-based RLS
  [Source: CLAUDE.md - RLS everywhere]

### Project Structure Alignment

- **Migrations Location:** `supabase/migrations/`
  [Source: CLAUDE.md - Project structure]
- **Naming Convention:** snake_case for tables/columns, `idx_` prefix for indexes
  [Source: CLAUDE.md - Conventions]

---

## Dev Notes

### Architecture Insights
- Event RSVP system is **completely isolated** from existing system - new tables only, no modifications to existing tables
- Uses existing `profiles.phone` field for WhatsApp validation
- Soft delete pattern mirrors existing codebase practice
- RLS policies follow admin/member role model (consistent with system)

### Service Filter Consideration
- **Note:** Unlike other tables, `event_confirmations` does NOT require a `service` filter (`.eq('service', 'ttcx')`) because this is a new system module, not shared with other services
- If service isolation is required in future, add `service_id` column and RLS policy

### Migration Testing Strategy
1. Create migration file locally
2. Run in dev Supabase environment
3. Verify tables exist with `\d events`, `\d event_confirmations`
4. Test RLS policies with different user roles (admin vs member)
5. Verify cascade delete works (delete event â†’ confirmations auto-delete)
6. Test uniqueness constraint (try inserting duplicate event_id + user_phone)

### Potential Challenges
- **Timezone handling:** All TIMESTAMP fields use UTC (Supabase default). When comparing `deadline < now()`, ensure consistent timezone handling in API layer
- **RLS Policy Performance:** The `user_phone` check requires a join to profiles table. Ensure indexes on `profiles.phone` exist (verify existing)
- **Soft Delete Queries:** Developers must remember to add `deleted_at IS NULL` filter in SELECT queries. Consider creating a view or SQL function for safety.

---

## Tasks / Subtasks

### Phase 1: Schema Creation
1. **Create events table migration**
   - Write SQL: table creation with all columns and constraints
   - Add indexes: `idx_events_created_by`, `idx_events_status_deleted`
   - Add check constraints on `status` and `confirmation_limit`
   - Reference: AC-1, AC-6

2. **Create event_confirmations table migration**
   - Write SQL: table creation with FK to events (CASCADE delete)
   - Add unique constraint: `(event_id, user_phone)`
   - Add indexes: `idx_event_confirmations_event_id`, `idx_event_confirmations_user_phone`
   - Add check constraint on `confirmed_count` (1-4 only)
   - Reference: AC-2, AC-3, AC-6

### Phase 2: RLS Policies
3. **Implement events table RLS**
   - Enable RLS on events table
   - Create 5 policies (admin select, member select, admin insert, admin update, admin delete)
   - Test: Admins see all, members see active only
   - Reference: AC-4

4. **Implement event_confirmations table RLS**
   - Enable RLS on event_confirmations table
   - Create 4 policies (admin select, member select, member insert, member update)
   - Test: Admins see all, members see own only
   - Reference: AC-4

### Phase 3: Testing & Validation
5. **Test schema creation locally**
   - Run migration in dev Supabase
   - Verify tables exist with correct columns and types
   - Reference: AC-1, AC-2, AC-6

6. **Test RLS policies with different roles**
   - Test as admin: see all events, all confirmations
   - Test as member: see active events only, see own confirmations only
   - Test as public: no access to confirmations
   - Reference: AC-4

7. **Test cascade delete**
   - Create event â†’ create confirmations â†’ delete event
   - Verify confirmations deleted automatically
   - Reference: AC-3

8. **Test uniqueness constraint**
   - Try inserting duplicate `(event_id, user_phone)`
   - Verify database rejects with constraint error
   - Reference: AC-3

9. **Verify no regressions**
   - Run existing API tests to ensure all passing
   - Check that existing tables unmodified
   - Reference: AC-7

### Phase 4: Unit Tests (TypeScript/Jest)
10. **Create test file: `tests/database/events.test.ts`**
    - Test: Table existence and column types
    - Test: RLS policy enforcement (admin vs member access)
    - Test: Uniqueness constraint on `(event_id, user_phone)`
    - Test: Cascade delete on FK
    - Test: Soft delete filtering (deleted_at IS NULL)

---

## Pre-Commit Quality Gates

**Story Type:** Database
**Specialized Agents:** @data-engineer (primary), @dev (QA)

### CodeRabbit Focus Areas

**Primary Focus:**
- Schema compliance: All FK constraints, indexes properly defined
- RLS policies: Correctly configured and tested
- Data types: Appropriate types for each column
- Constraints: CHECK, UNIQUE, NOT NULL properly applied

**Secondary Focus:**
- Migration reversibility: Includes proper DOWN migration
- Performance: Indexes on frequently queried columns
- Naming conventions: Follows project patterns

### Quality Gate Checklist

- [ ] **Schema Validation**
  - [ ] All columns have correct data types
  - [ ] All NOT NULL constraints applied where needed
  - [ ] Primary keys set up correctly
  - [ ] Foreign keys reference correct tables
  - [ ] Unique constraints defined

- [ ] **RLS Policies**
  - [ ] RLS enabled on both tables
  - [ ] Admin access verified (can CRUD everything)
  - [ ] Member access restricted (can only see/modify own data)
  - [ ] Public access tested (should see nothing sensitive)

- [ ] **Migration Safety**
  - [ ] Migration file is reversible (has DOWN statement)
  - [ ] Migration tested in dev environment without errors
  - [ ] No data loss from running migration

- [ ] **Performance**
  - [ ] Indexes created on FK columns
  - [ ] Indexes created on frequently queried columns
  - [ ] No missing indexes causing table scans

- [ ] **Testing**
  - [ ] Unit tests written and passing
  - [ ] RLS policies tested with different roles
  - [ ] Cascade delete tested
  - [ ] Uniqueness constraint tested

---

## Success Criteria

Story is **COMPLETE** when:

1. âœ… Both tables created in Supabase with all columns and correct types
2. âœ… All indexes and constraints properly defined
3. âœ… RLS policies implemented and tested (admin sees all, member sees own)
4. âœ… Soft delete pattern working (events marked deleted not physically removed)
5. âœ… Migration file created, tested, and reversible
6. âœ… No regressions: existing tables and API routes unaffected
7. âœ… Pre-Commit QA passed (@dev validates schema and RLS)
8. âœ… Unit tests written and all passing
9. âœ… File List updated with migration file

---

## ðŸ¤– CodeRabbit Integration

**Story Type Analysis:**
- **Primary Type:** Database
- **Complexity:** Medium (2 tables, FK relationship, comprehensive RLS policies)

**Specialized Agent Assignment:**
- **Primary Agents:** @data-engineer, @dev
- **Quality Gate:** Pre-Commit (@dev validates schema & RLS)

**Self-Healing Configuration (Story 6.3.3):**
- **Mode:** light (primary agent @data-engineer)
- **Max Iterations:** 2
- **Timeout:** 15 minutes
- **Severity Filter:** CRITICAL only
- **Expected Behavior:** CRITICAL issues auto-fixed up to 2 iterations, HIGH issues documented

---

## File List

**New Files Created:**
- `supabase/migrations/20260217200000_create_events_tables.sql` â€” Table creation + RLS policies + indexes

**Modified Files:**
- None. This is a new, isolated feature.

**Files Reviewed (Architecture Reference):**
- `CLAUDE.md` â€” Database patterns and RLS structure
- `docs/03-ARCHITECTURE/brownfield-architecture.md` â€” Project structure

---

## Change Log

| Date | Author | Change | Status |
|------|--------|--------|--------|
| 2026-02-17 | River (@sm) | Story created | Draft |
| 2026-02-17 | Pax (@po) | Validated (8/10 GO) â€” Missing: complexity estimate, explicit IN/OUT scope | Ready |
| 2026-02-17 | Dara (@data-engineer) | Migration created: events + event_confirmations + RLS (is_admin pattern) + indexes + triggers | InProgress |
| â€” | @dev | QA validation pending | â€” |

---

## Related Stories

- **Blocks:** EPIC-1-STORY-2 (APIs depend on schema)
- **Blocks:** EPIC-1-STORY-3 (RSVP page depends on schema)
- **Blocks:** EPIC-1-STORY-4 (Admin dashboard depends on schema)

---

*Story created via `*draft` command by @sm (River)*
