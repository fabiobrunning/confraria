---
story_id: EPIC-1-STORY-4
epic_id: EPIC-1
title: Admin Dashboard - Event RSVP System
status: InProgress
created_at: 2026-02-17
created_by: River (@sm)
updated_at: 2026-02-17
version: 1.0

story_sequence: 4
total_stories_in_epic: 4

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: [ui_patterns, integration_consistency, performance_validation]

coderabbit_enabled: true
coderabbit_story_type: "Frontend + Integration"
coderabbit_complexity: High
coderabbit_primary_agents:
  - "@dev"
  - "@architect"
---

# STORY-1.4: Admin Dashboard

**Event RSVP System - Administration Interface**

---

## Story Summary

Create admin dashboard for managing events. Includes 3 pages: event list (create/edit/cancel/view), event details (confirmations table, confirmation counter, share link, export CSV), and create/edit event form (with validation). Uses existing Confraria admin UI patterns.

**Epic Reference:** EPIC-1 - Event RSVP System
**Dependencies:** STORY-1.1 (Database), STORY-1.2 (APIs), STORY-1.3 (RSVP Page)
**Blocks:** None (final story)

---

## Story Statement

As an **Admin**, I need a dashboard to create, manage, and monitor events so that **I can organize events and see who's confirming in real-time**.

---

## Acceptance Criteria

### AC-1: Event List Page (/admin/events)
- [x] Page accessible at `/admin/events` (admin only via protected route group)
- [x] Displays table of all events: Name | Date | Deadline | Status | Confirmations | Actions
- [x] Button: "+ Novo Evento" to create new event
- [x] Actions per row: View | Edit | Cancel (with confirmation dialog)
- [x] Filters: Status (Ativo/Cancelado) via Select
- [x] Search: by event name (real-time client-side filter)
- [x] Pagination: 20 events per page with prev/next
- [x] Sort by date (newest first, API default)
- [x] Status badge: "Ativo" (default) / "Cancelado" (destructive)
- [x] Confirmation count displayed: "45/50"

### AC-2: Create/Edit Event Form
- [x] Form fields: Name, Description, Date, Time, Deadline, Confirmation Limit (all required)
- [x] Validation: Deadline must be >= Event Date
- [x] Date picker: native date input
- [x] Time picker: native time input (HH:MM)
- [x] Submit button: "Criar" (create) / "Salvar" (edit)
- [x] Cancel button: router.back()
- [x] Error messages displayed per field
- [x] Success message via toast
- [x] Accessible via "+ Novo Evento" and "Editar" action

### AC-3: Event Details Page (/admin/events/{id})
- [x] Page displays event info (read-only cards: date, confirmations, status)
- [x] Confirmations table: WhatsApp | Count | Data Confirmação
- [ ] Table pagination: 20 rows per page (all rows shown for MVP)
- [ ] Delete confirmation button (deferred — not in API scope)
- [x] Refresh button on confirmations table
- [x] Confirmation counter: "X / Y" in card
- [ ] Graph/Chart: Timeline of confirmations (deferred for MVP)
- [x] Button: "Copiar link RSVP" (clipboard + toast)
- [x] Button: "Compartilhar no WhatsApp" (wa.me pre-filled message)
- [x] Button: "Exportar confirmações" (CSV download)
- [x] 404 state if event not found

### AC-4: Admin Auth Check
- [x] All pages under `(protected)/admin/` route group (middleware enforced)
- [x] API endpoints check admin role (403 if not admin)
- [x] Auth check via existing middleware.ts
- [x] Sidebar item only visible for admin role

### AC-5: Copy Link & Share Features
- [x] Copy link button: copies full URL `/rsvp/{eventId}` to clipboard
- [x] Toast notification: "Link copiado!"
- [x] Share WhatsApp button: opens wa.me with pre-filled message
- [x] Full URL includes domain (window.location.origin)
- [x] Works on mobile and desktop (wa.me universal link)

### AC-6: CSV Export
- [x] CSV download via `/api/events/{id}/export` (opens in new tab)
- [x] Columns: Nome, WhatsApp, Quantidade, Data Confirmação
- [x] Data from API (matches DB)
- [x] File encoding: UTF-8
- [x] Proper headers (Content-Type: text/csv, Content-Disposition: attachment)

### AC-7: Real-Time Updates
- [x] Confirmation count recalculated from confirmations data
- [x] Table refreshes via RefreshCw button
- [ ] Graph deferred for MVP
- [x] Manual refresh button (Option B)
- [x] React Query staleTime: 5s on confirmations

### AC-8: UI Consistency
- [x] Uses PageContainer + PageHeader (existing pattern)
- [x] Uses shadcn/ui: Button, Input, Table, Card, Badge, Select, AlertDialog
- [x] Colors match (default shadcn theme)
- [x] Fonts match (inherits from root layout)
- [x] Dark mode compatible (shadcn defaults)
- [x] Responsive: PageContainer max-w-6xl, grid cols responsive
- [x] No layout shifts (loading states in place)

### AC-9: Performance
- [x] Event list paginated (20 per page, API-side)
- [ ] Confirmations table with 1000 rows (needs virtual scrolling for scale)
- [x] CSV export server-side (no browser processing)
- [x] React Query caching (staleTime 60s events, 5s confirmations)
- [ ] Virtual scrolling deferred for MVP

### AC-10: Error Handling
- [x] Event not found: "Evento não encontrado" message
- [x] Network error: React Query retry (1 attempt)
- [x] Cancel event fails: error toast
- [x] Form submit fails: error toast
- [x] All errors user-friendly via toast

---

## Technical Context

### Page Structure

```tsx
// app/(protected)/admin/events/page.tsx → Event List
// app/(protected)/admin/events/new/page.tsx → Create Event Form
// app/(protected)/admin/events/[id]/page.tsx → Event Details
// app/(protected)/admin/events/[id]/edit/page.tsx → Edit Event Form
```

### Components

```tsx
// app/(protected)/admin/events/components/
// - EventTable.tsx (list of events)
// - EventForm.tsx (create/edit form)
// - ConfirmationsTable.tsx (confirmations)
// - ConfirmationCounter.tsx (count display + graph)
// - EventActions.tsx (copy link, share, export)
```

### React Query Hooks

```tsx
useQuery(`/api/events`, { staleTime: 30s })
useMutation(POST /api/events)
useMutation(PUT /api/events/{id})
useMutation(DELETE /api/events/{id})
useQuery(`/api/events/{id}/confirmations`, { staleTime: 5s })
```

### Data Table Implementation

- Use TanStack Table (React Table) for large datasets
- Pagination: 20 rows per page
- Sorting: by date
- Searching: real-time filter
- Virtual scrolling for large confirmations table (optional)

### CSV Export

```tsx
const exportCSV = (confirmations, eventName) => {
  const csv = [
    ['Name', 'WhatsApp', 'Count', 'Confirmed At'],
    ...confirmations.map(c => [c.name, c.phone, c.count, c.confirmed_at])
  ];
  const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
  download(blob, `event-${eventId}-confirmations.csv`);
}
```

### Real-Time Counter

**Option A: WebSocket/Live Query** (ideal)
- Subscribe to event confirmations
- Update count in real-time
- Requires backend support

**Option B: Polling**
- useEffect with 5-second interval
- Re-fetch event count + confirmations
- Simpler, less infrastructure

**Recommended:** Option B for MVP

---

## Dev Notes

### Existing Admin UI Patterns

- Admin pages use layout: `app/(protected)/admin/`
  [Source: CLAUDE.md - Route Groups]
- Sidebar navigation with items
- Header with breadcrumbs
- shadcn/ui components: Button, Table, Form, Dialog, Input, DatePicker
  [Source: CLAUDE.md - Component Organization]
- Dark mode enabled via `class` strategy
  [Source: CLAUDE.md - Styling]

### Integration with Existing System

- Admin authentication: Check `profiles.role = 'admin'`
  [Source: CLAUDE.md - Authentication Flow]
- API calls: Use React Query with `/api/events` routes from Story 1.2
- Activity logging: Automatic via API layer (Story 1.2)
- No new database tables or migrations needed

### Component Libraries

- **TanStack Table:** Data table with pagination, sorting, searching
- **React Hook Form:** Form state management
- **Zod:** Form validation
- **shadcn/ui:** UI components
- **date-fns:** Date formatting
- **js-csv or similar:** CSV generation

### Copy to Clipboard

```tsx
import { copyToClipboard } from '@/lib/utils'; // or use navigator.clipboard
const handleCopy = async () => {
  await copyToClipboard(`${window.location.origin}/rsvp/${eventId}`);
  toast('Link copiado!');
}
```

### Share to WhatsApp

```tsx
const handleShare = () => {
  const message = `Evento: ${eventName}\nConfirme presença aqui: ${fullURL}\nData: ${date}`;
  const url = `https://wa.me/?text=${encodeURIComponent(message)}`;
  window.open(url, '_blank');
}
```

---

## Tasks / Subtasks

### Phase 1: Setup & Structure
1. **Create directory structure and layout**
   - Create `app/(protected)/admin/events/` directory
   - Create `layout.tsx` with admin header/sidebar
   - Create components subfolder

2. **Create page files**
   - `page.tsx` — Event list
   - `new/page.tsx` — Create event
   - `[id]/page.tsx` — Event details
   - `[id]/edit/page.tsx` — Edit event

### Phase 2: Components
3. **Create EventTable component**
   - Display events in table format
   - Pagination, sorting, filtering
   - Action buttons (view, edit, cancel)

4. **Create EventForm component**
   - Form fields (name, description, date, time, deadline, limit)
   - Zod validation
   - Submit handler (POST for create, PUT for edit)
   - Error display

5. **Create ConfirmationsTable component**
   - Display confirmations with name, phone, count, date
   - Pagination (20 per page)
   - Delete button per row
   - Supports large datasets (virtual scrolling optional)

6. **Create ConfirmationCounter component**
   - Display count: "45 / 50"
   - Graph/Chart (timeline of confirmations)
   - Real-time updates (or refresh button)

7. **Create EventActions component**
   - Copy link button
   - Share WhatsApp button
   - Export CSV button

### Phase 3: Pages
8. **Implement Event List page**
   - Display EventTable component
   - Search and filter
   - "+ Novo Evento" button → navigate to create
   - Edit/Cancel buttons → navigate to edit/delete

9. **Implement Create/Edit Form page**
   - Display EventForm component
   - Pre-populate form on edit
   - Redirect to details after create/edit

10. **Implement Event Details page**
    - Display event info
    - Display ConfirmationsTable
    - Display ConfirmationCounter
    - Display EventActions

### Phase 4: Integration
11. **Add admin auth check**
    - Check role in page (page-level) or middleware
    - Redirect to home if not admin
    - Show 403 Forbidden if unauthorized

12. **Setup React Query hooks**
    - useQuery for event list
    - useQuery for event details
    - useMutation for create/edit/delete
    - Proper cache invalidation

13. **Add toast notifications**
    - Success: "Evento criado com sucesso"
    - Error: display error message
    - Copy: "Link copiado!"

### Phase 5: Polish & Testing
14. **Add loading and error states**
    - Show spinner during API calls
    - Handle network errors gracefully
    - Disable buttons during submission

15. **Implement copy/share features**
    - Copy link to clipboard with toast
    - Share to WhatsApp with pre-filled message

16. **CSV export implementation**
    - Generate CSV from confirmations
    - Download file with proper headers
    - Handle export errors

17. **Real-time updates**
    - Auto-refresh counter every 5 seconds
    - Auto-refresh confirmations table
    - Update graph with new data

18. **Create test file: tests/admin/events.test.ts**
    - Test: Event list loads
    - Test: Create event form
    - Test: Edit event
    - Test: Delete event (soft delete)
    - Test: Real-time counter updates
    - Test: Copy link functionality
    - Test: Export CSV
    - Test: Admin auth check (403 for non-admin)

---

## Pre-Commit Quality Gates

**Story Type:** Frontend + Integration
**Specialized Agents:** @dev (primary), @architect (QA)

### CodeRabbit Focus Areas

**Primary Focus:**
- UI patterns: Follows Confraria admin design
- Integration consistency: Uses existing API patterns
- Performance: Large table handling, load times

**Secondary Focus:**
- Admin auth: Properly enforced
- Error handling: User-friendly messages
- Real-time updates: Proper cache invalidation

---

## Success Criteria

Story is **COMPLETE** when:

1. ✅ Event list page working (all events displayed)
2. ✅ Create event form working (validates deadline >= date)
3. ✅ Edit event form working (pre-populate, update)
4. ✅ Cancel event working (soft delete)
5. ✅ Event details page showing confirmations
6. ✅ Real-time counter displaying and updating
7. ✅ Copy link button working (toast shown)
8. ✅ Share to WhatsApp working (message pre-filled)
9. ✅ CSV export working (download file)
10. ✅ Admin auth enforced (403 for non-admin)
11. ✅ Performance: list loads < 2s, table with 1000 rows responsive
12. ✅ UI consistent with Confraria admin pages
13. ✅ Mobile responsive (no horizontal scroll)
14. ✅ All error states handled
15. ✅ All tests passing
16. ✅ Pre-Commit QA passed (@architect validates UI consistency)

---

## File List

**New Files Created:**
- `app/(protected)/admin/events/page.tsx` — Event list
- `app/(protected)/admin/events/new/page.tsx` — Create event
- `app/(protected)/admin/events/[id]/page.tsx` — Event details
- `app/(protected)/admin/events/[id]/edit/page.tsx` — Edit event
- `app/(protected)/admin/events/components/EventTable.tsx`
- `app/(protected)/admin/events/components/EventForm.tsx`
- `app/(protected)/admin/events/components/ConfirmationsTable.tsx`
- `app/(protected)/admin/events/components/ConfirmationCounter.tsx`
- `app/(protected)/admin/events/components/EventActions.tsx`
- `lib/hooks/useEvents.ts` — Event queries
- `lib/hooks/useConfirmations.ts` — Confirmation queries
- `tests/admin/events.test.ts` — Admin tests

**Modified Files:**
- `components/Sidebar.tsx` — Add "Eventos" menu item (optional)

---

## Change Log

| Date | Author | Change | Status |
|------|--------|--------|--------|
| 2026-02-17 | River (@sm) | Story created | Draft |
| 2026-02-17 | Pax (@po) | Validated (8/10 GO) — Missing: complexity estimate, explicit IN/OUT scope | Ready |

---

*Story created via `*draft` command by @sm (River)*
