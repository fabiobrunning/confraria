---
story_id: EPIC-1-STORY-2
epic_id: EPIC-1
title: Event Management APIs - Event RSVP System
status: InProgress
created_at: 2026-02-17
created_by: River (@sm)
updated_at: 2026-02-17
version: 1.0

story_sequence: 2
total_stories_in_epic: 4

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: [api_contract_validation, security_scan, backward_compatibility]

coderabbit_enabled: true
coderabbit_story_type: API
coderabbit_complexity: High
coderabbit_primary_agents:
  - "@dev"
  - "@architect"
---

# STORY-1.2: Event Management APIs

**Event RSVP System - API Endpoints**

---

## Story Summary

Create 8 REST API endpoints to manage events and confirmations. Endpoints include creating/listing/editing/canceling events (admin only) and confirming attendance (public with WhatsApp validation). All endpoints implement security validation, rate limiting, and activity logging.

**Epic Reference:** EPIC-1 - Event RSVP System
**Dependencies:** STORY-1.1 (Database Schema)
**Blocks:** STORY-1.3, STORY-1.4 (depend on API)

---

## Story Statement

As a **Developer**, I need to create REST API endpoints for event management so that **the frontend can create/update/delete events and users can confirm attendance**.

---

## Acceptance Criteria

### AC-1: POST /api/events (Create Event)
- [x] Endpoint creates new event with validated input (name, description, date, time, deadline, confirmation_limit)
- [x] Only admins can call this endpoint (403 if not admin)
- [x] Input validated with Zod schema
- [x] Deadline must be >= event date (validation error if not)
- [x] Returns 201 + event object on success
- [x] Returns 400 with error message on validation failure
- [x] Activity log created for event creation

### AC-2: GET /api/events (List Events)
- [x] Endpoint returns list of all events (admin) or active only (members)
- [x] Admin sees all events including cancelled/deleted
- [x] Member sees only active, non-deleted events
- [x] Pagination support (default: 20 per page)
- [x] Filtering by status (active/cancelled)
- [x] Sorting by date (newest first)
- [x] Returns 200 + events array

### AC-3: GET /api/events/{id} (Get Event Details)
- [x] Returns event info + confirmation count
- [x] Admin sees all events, member sees only active
- [x] Returns 404 if event not found
- [x] Returns 200 + event object with confirmations count
- [x] Public can call (limited info: name, description, date, time, total confirmations, deadline)

### AC-4: PUT /api/events/{id} (Update Event)
- [x] Updates event fields (name, description, date, time, deadline, confirmation_limit, status)
- [x] Only admins can update (403 if not admin)
- [x] Deadline validation: must be >= event date
- [x] Returns 200 + updated event on success
- [x] Returns 400 on validation failure
- [x] Returns 404 if event not found
- [x] Activity log created for event update

### AC-5: DELETE /api/events/{id} (Cancel Event)
- [x] Soft delete: sets status='cancelled' and deleted_at=now()
- [x] Only admins can delete (403 if not admin)
- [x] Returns 204 No Content on success
- [x] Returns 404 if event not found
- [x] Activity log created for event cancellation

### AC-6: POST /api/events/{id}/confirm (Confirm Attendance)
- [x] Creates confirmation with WhatsApp validation
- [x] Accepts: user_phone (validated format), confirmed_count (1-4)
- [x] Validates: phone exists in profiles table
- [x] Validates: event exists and is active (not cancelled/deleted)
- [x] Validates: deadline not passed
- [x] Validates: confirmed_count is 1, 2, 3, or 4
- [x] Rate limiting: max 10 confirmations per IP per minute (returns 429 if exceeded)
- [x] Prevents duplicate confirmations: UPSERT (update if exists)
- [x] Returns 201 + confirmation object on success
- [x] Returns 400 on validation failure
- [x] Returns 404 if event not found
- [x] Activity log created for confirmation

### AC-7: GET /api/events/{id}/confirmations (List Confirmations)
- [x] Returns array of all confirmations for an event
- [x] Only admins can call (403 if not admin)
- [x] Includes: user_phone, confirmed_count, confirmed_at
- [x] Sorted by confirmed_at ascending
- [x] Returns 200 + confirmations array
- [x] Returns 404 if event not found

### AC-8: GET /api/events/{id}/export (Export CSV)
- [x] Exports confirmations as CSV file
- [x] Only admins can call (403 if not admin)
- [x] CSV columns: name, phone, count, confirmed_at
- [x] Returns 200 + file download (Content-Type: text/csv)
- [x] Filename: `event-{id}-confirmations.csv`
- [x] Returns 404 if event not found

---

## Technical Context

### API Endpoints Reference

**Base:** `/api/events`

| Method | Path | Auth | Rate Limit |
|--------|------|------|-----------|
| POST | `/api/events` | Admin | Standard |
| GET | `/api/events` | Admin | Standard |
| GET | `/api/events/{id}` | Public | Standard |
| PUT | `/api/events/{id}` | Admin | Standard |
| DELETE | `/api/events/{id}` | Admin | Standard |
| POST | `/api/events/{id}/confirm` | Public | 10/min per IP |
| GET | `/api/events/{id}/confirmations` | Admin | Standard |
| GET | `/api/events/{id}/export` | Admin | Standard |

### Request/Response Schemas (Zod)

**Create Event Request:**
```typescript
const createEventSchema = z.object({
  name: z.string().min(1).max(255),
  description: z.string().min(1),
  date: z.string().date(),
  time: z.string().regex(/^\d{2}:\d{2}$/),
  deadline: z.string().datetime(),
  confirmation_limit: z.number().int().min(1),
});
```

**Confirm Attendance Request:**
```typescript
const confirmAttendanceSchema = z.object({
  user_phone: z.string().regex(/^\(\d{2}\)\s\d{4,5}-\d{4}$/),
  confirmed_count: z.number().int().min(1).max(4),
});
```

### Validation & Security

**Admin Check:** Query `profiles` table for `role='admin'`
```sql
SELECT role FROM profiles WHERE id = auth.uid()
```

**WhatsApp Validation:** Check phone exists in profiles
```sql
SELECT phone FROM profiles WHERE phone = $1 AND deleted_at IS NULL
```

**Rate Limiting:** In-memory store (lib/rate-limit.ts pattern from existing codebase)
- Track by IP address
- 10 confirmations per minute
- Return 429 Too Many Requests if exceeded

**Activity Logging:** Log all operations to `activity_logs` table
- `action`: 'create_event', 'update_event', 'delete_event', 'confirm_attendance'
- `resource`: 'events', 'event_confirmations'
- `resource_id`: event_id or confirmation_id
- `user_id`: admin or confirming user
- Fire-and-forget (don't block response)

### Error Responses

**400 Bad Request (Validation):**
```json
{ "success": false, "error": "Validation failed", "details": { "field": "error message" } }
```

**403 Forbidden (Not Admin):**
```json
{ "success": false, "error": "Admin access required" }
```

**404 Not Found:**
```json
{ "success": false, "error": "Event not found" }
```

**429 Too Many Requests:**
```json
{ "success": false, "error": "Rate limit exceeded. Try again in 1 minute." }
```

**Success Response:**
```json
{ "success": true, "data": { ...event object... } }
```

---

## Dev Notes

### Existing Patterns

- **API Structure:** Follow existing route structure in `app/api/` (see CLAUDE.md)
  [Source: CLAUDE.md - Route Groups]
- **Response Format:** Use `apiSuccess()` / `apiError()` from `lib/api-response.ts`
  [Source: CLAUDE.md - API Route Pattern]
- **Zod Validation:** All requests validated with Zod schemas in `lib/schemas.ts`
  [Source: CLAUDE.md - Validation Schemas]
- **Rate Limiting:** Use `lib/rate-limit.ts` (in-memory, resets on restart)
  [Source: CLAUDE.md - Pre-Registration System]
- **Activity Logging:** Use `lib/activity-log.ts` fire-and-forget pattern
  [Source: CLAUDE.md - API Route Pattern]

### WhatsApp Validation Integration

- Phone format: `(00) 00000-0000` → normalize to `00000000000` for lookup
- Query `profiles.phone` field (already indexed)
- Return 400 if not found
- Do NOT require auth token (public endpoint)

### Rate Limiting Notes

- Track by `req.ip` or `req.headers['x-forwarded-for']`
- 10 req/min per IP for `/confirm` endpoint only
- Other endpoints: standard rate limit (if exists)
- In-memory store means limit resets on restart

### Migration from WhatsApp

- No changes to existing groups/cotas system
- Phone validation uses existing `profiles.phone` field
- Zero impact on member management

---

## Tasks / Subtasks

### Phase 1: Project Setup
1. **Create route files and directory structure**
   - Create `app/api/events/route.ts` for POST, GET (list)
   - Create `app/api/events/[id]/route.ts` for GET, PUT, DELETE
   - Create `app/api/events/[id]/confirm/route.ts` for POST confirm
   - Create `app/api/events/[id]/confirmations/route.ts` for GET
   - Create `app/api/events/[id]/export/route.ts` for CSV export
   - Reference: AC-1 to AC-8

2. **Create Zod schemas in lib/schemas/events.ts**
   - Create Event schema
   - Confirm Attendance schema
   - Update Event schema
   - Reference: Validation context

### Phase 2: Implement Core Endpoints
3. **Implement POST /api/events (Create)**
   - Validate input with Zod
   - Check admin role
   - Insert event into DB
   - Log activity
   - Return 201 + event
   - Reference: AC-1

4. **Implement GET /api/events (List)**
   - Check admin role
   - Query events (all for admin, active for member)
   - Add pagination
   - Return 200 + array
   - Reference: AC-2

5. **Implement GET /api/events/{id} (Details)**
   - Parse event ID
   - Query event + confirmation count
   - Check RLS (admin sees all, member sees active)
   - Return 200 + event or 404
   - Reference: AC-3

6. **Implement PUT /api/events/{id} (Update)**
   - Parse event ID
   - Validate input
   - Check admin role
   - Validate deadline >= date
   - Update event in DB
   - Log activity
   - Return 200 + updated event or 404
   - Reference: AC-4

7. **Implement DELETE /api/events/{id} (Soft Delete)**
   - Parse event ID
   - Check admin role
   - Set status='cancelled', deleted_at=now()
   - Log activity
   - Return 204 or 404
   - Reference: AC-5

### Phase 3: Implement Confirmation Endpoint
8. **Implement POST /api/events/{id}/confirm (Confirm Attendance)**
   - Parse event ID
   - Validate input (phone format, confirmed_count 1-4)
   - Check rate limit (10/min per IP)
   - Validate phone exists in profiles
   - Validate event exists and active
   - Validate deadline not passed
   - UPSERT confirmation (update if exists, insert if new)
   - Log activity
   - Return 201 + confirmation or 400/429
   - Reference: AC-6

### Phase 4: Query Endpoints
9. **Implement GET /api/events/{id}/confirmations (List)**
   - Parse event ID
   - Check admin role
   - Query confirmations sorted by confirmed_at
   - Return 200 + array or 404
   - Reference: AC-7

10. **Implement GET /api/events/{id}/export (CSV Export)**
    - Parse event ID
    - Check admin role
    - Query confirmations + event name
    - Format as CSV (name, phone, count, confirmed_at)
    - Set headers: Content-Type: text/csv, Content-Disposition: attachment
    - Return 200 + file or 404
    - Reference: AC-8

### Phase 5: Testing
11. **Create test file: tests/api/events.test.ts**
    - Test: Create event (admin only)
    - Test: List events (admin sees all, member sees active)
    - Test: Get event details
    - Test: Update event (admin only, validate deadline)
    - Test: Delete event (soft delete)
    - Test: Confirm attendance (validate phone, rate limit)
    - Test: List confirmations (admin only)
    - Test: Export CSV (admin only)
    - Test: Error responses (400, 403, 404, 429)

---

## Pre-Commit Quality Gates

**Story Type:** API
**Specialized Agents:** @dev (primary), @architect (QA)

### CodeRabbit Focus Areas

**Primary Focus:**
- Error handling: Try-catch blocks, proper error responses
- Security: Input validation, admin checks, rate limiting
- API contracts: Consistent responses, proper status codes

**Secondary Focus:**
- Backward compatibility: No changes to existing endpoints
- Rate limiting: Properly implemented and tested
- Activity logging: All operations logged

---

## Success Criteria

Story is **COMPLETE** when:

1. ✅ All 8 endpoints implemented and callable
2. ✅ Admin authentication checked on protected endpoints
3. ✅ WhatsApp validation working (phone lookup in profiles)
4. ✅ Rate limiting active on `/confirm` (10/min)
5. ✅ UPSERT working for confirmations (update if exists)
6. ✅ Activity logging working for all operations
7. ✅ Error responses correct (400, 403, 404, 429)
8. ✅ Deadline validation working (deadline >= date)
9. ✅ CSV export working correctly
10. ✅ All tests passing
11. ✅ Pre-Commit QA passed (@architect validates API design)

---

## File List

**New Files Created:**
- `app/api/events/route.ts` — POST (create), GET (list)
- `app/api/events/[id]/route.ts` — GET, PUT, DELETE
- `app/api/events/[id]/confirm/route.ts` — POST confirm
- `app/api/events/[id]/confirmations/route.ts` — GET
- `app/api/events/[id]/export/route.ts` — GET export
- `lib/schemas/events.ts` — Zod schemas
- `tests/api/events.test.ts` — API tests

**Modified Files:**
- None. Backward compatible.

---

## Change Log

| Date | Author | Change | Status |
|------|--------|--------|--------|
| 2026-02-17 | River (@sm) | Story created | Draft |
| 2026-02-17 | Pax (@po) | Validated (8/10 GO) — Missing: complexity estimate, explicit IN/OUT scope | Ready |
| 2026-02-17 | Dex (@dev) | 8 endpoints + validate-phone + schemas + activity-log types. TypeCheck: 0 errors | InProgress |
| 2026-02-18 | Dara (@data-engineer) | Added activity log to confirm endpoint (AC-6). Regenerated Supabase types. All ACs complete. | InProgress |

---

*Story created via `*draft` command by @sm (River)*
